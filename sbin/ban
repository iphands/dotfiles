#!/bin/bash
set -e

if [ "$1" != "FULL" ]
then
  opt="300 minutes ago"
else
  opt="30 days ago"
fi

LIST_FILE="/root/ban/.ip.list.txt"
BANLOG_FILE="/root/ban/.ban.log"
LIST_FILE_RAW="${LIST_FILE}.raw"

touch $LIST_FILE
touch $LIST_FILE_RAW

OLD_COUNT="$(firewall-cmd --ipset=bad_ips --get-entries | wc -l)"
OLD_SUM="`md5sum $LIST_FILE`"

echo "## Finding bad actors"
set +e
journalctl -u sshd --since="${opt}" | grep 'Failed password' | grep ' from ' | grep -E -o 'from [0-9\.]*' >> $LIST_FILE_RAW
grep jndi /var/log/nginx/*.access.log | grep -E '^[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}. -' | awk '{print $1}' >> $LIST_FILE_RAW
grep jndi /var/log/nginx/error.log | grep host | grep -E -o 'host: "[0-9.]*"$' | cut -d\" -f2 >> $LIST_FILE_RAW
grep 404 /var/log/nginx/*access.log | grep \
    -e 'x00.x00' \
    -e .git/config \
    -e /.env \
    -e \.php \
    -e env.local \
    -e phpunit \
    -e wp-content \
    -e wp-good \
    -e wp-inc \
    -e wp-includes \
    -e wp-json \
    -e wp-login \
    /var/log/nginx/*access.log | cut -d':' -f2 | cut -d' ' -f1 | sort -u >> $LIST_FILE_RAW
set -e

cat $LIST_FILE_RAW | sort -u | cut -f2 -d' ' | grep '^[0-9]' > $LIST_FILE
NEW_SUM="`md5sum $LIST_FILE`"

# [[ "$OLD_SUM" == "$NEW_SUM" ]] && exit 0

echo "## Bouncing firewall"
# systemctl restart firewall
firewall-cmd --reload
firewall-cmd --permanent --new-ipset=bad_ips --type=hash:ip || true

echo "## Adding bad actors"
firewall-cmd --permanent --ipset=bad_ips --add-entries-from-file="$LIST_FILE"

echo "## Exlude me"
for var in 67.185.161.120
do
    firewall-cmd --permanent --ipset=bad_ips --remove-entry "$var" || true
done

echo "## Enable rejections"
firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source ipset="bad_ips" reject'

echo "## Old count:"
echo $OLD_COUNT

echo "## New count:"
firewall-cmd --ipset=bad_ips --get-entries | wc -l
echo "`wc -l $LIST_FILE | awk '{print $1}'` `date`" >> $BANLOG_FILE

firewall-cmd --ipset=bad_ips --get-entries > $LIST_FILE_RAW
