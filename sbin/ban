#!/bin/bash
# Ban script - blocks SSH brute-force attackers using firewall
set -eo pipefail

# Detect IP family (ipv4 or ipv6)
get_ip_family() {
    local ip="$1"
    if [[ "$ip" == *":"* ]]; then
        echo "ipv6"
    else
        echo "ipv4"
    fi
}

if [ "$1" != "FULL" ]
then
  opt="300 minutes ago"
else
  opt="7 days ago"
fi

LIST_FILE="/root/ban/.ip.list.txt"
BANLOG_FILE="/root/ban/.ban.log"
LIST_FILE_RAW="${LIST_FILE}.raw"
LIST_FILE_TMP="${LIST_FILE}.bak"

OLD_COUNT="$(fgrep -c 'from' "$LIST_FILE_RAW" 2>/dev/null || true)"

echo "Finding bad actors"
time journalctl -u sshd --since="${opt}" | fgrep 'Failed password' | fgrep ' from ' | grep -oE 'from ([0-9]{1,3}\.){3}[0-9]{1,3}|from ([0-9a-fA-F]{0,4}:){2,7}[0-9a-fA-F]{0,4}' >> "$LIST_FILE_RAW"
sort -u "$LIST_FILE_RAW" | cut -f2 -d' ' > "$LIST_FILE"

echo "Bouncing firewall"
# systemctl restart firewall
firewall-cmd --reload

MY_IP=$(cat /root/ban/myip.txt)
echo "Adding bad actors"
while IFS= read -r IP
do
  if [[ "$MY_IP" != "$IP" ]]; then
    family=$(get_ip_family "$IP")
    echo "  adding $IP"
    # iptables -w 60 -A IN_public_deny -s $IP -j REJECT
    firewall-cmd --add-rich-rule="rule family='${family}' source address='$IP' reject"
  fi
done < "$LIST_FILE"

echo "Old count:"
echo "$OLD_COUNT"

echo "New count:"
wc -l < "$LIST_FILE"
echo "$(wc -l < "$LIST_FILE") $(date)" >> "$BANLOG_FILE"

cp "$LIST_FILE_RAW" "$LIST_FILE_TMP"
sort -u "$LIST_FILE_TMP" | fgrep -v 'from from' > "$LIST_FILE_RAW"
rm "$LIST_FILE_TMP"
