#!/bin/bash
set -eo pipefail

MAIN=eDP-1
MON_WORK_ONE=DP-3-3
MON_WORK_TWO=DP-3-1
MODES="above|work|same|right|home|single"

_check() {
  if [[ $1 == "" ]]
  then
    echo "assertion failed: empty option found"
    exit 1
  fi
}

_fail_no_mode() {
  echo "Error: must supply a mode as arg1 <$MODES>"
  exit 1
}

_fail_bad_mode() {
  echo "Error: invalid mode $1 (expected <$MODES>)"
  exit 1
}

_do_auto() {
  out="`xrandr --query --props`"
  single_test_sum="`xrandr | grep -F ' connected ' | md5sum | awk '{print $1}'`"
  echo "$out" | grep -q 00ffffffffffff0010acfb404c443141 && _main "work" "from_auto" && exit 0
  [[ "$single_test_sum" == "1cabd7be17c7fd2c54466895839932bc" ]] && _main "single" "from_auto" && exit 0
}

_do_work() {
  display_count=`xrandr | grep -e $MAIN -e $MON_WORK_ONE -e $MON_WORK_TWO | wc -l`
  if [[ "$display_count" != "3" ]]
  then
    return 1
  fi
  echo "# Found all three monitors, doing desk setup"

  echo "## Turning off external monitors"
  xrandr \
    --output $MON_WORK_ONE --off \
    --output $MON_WORK_TWO --off

  echo "## Forcing laptop as primary"
  xrandr --output $MAIN --mode 1920x1080 --primary

  echo "## Setting up upper monitor"
  xrandr --output $MON_WORK_ONE --above $MAIN --mode 2560x1600

  echo "## Setting up right side monitor"
  xrandr --output $MON_WORK_TWO --right-of $MON_WORK_ONE --mode 2560x1600
  return 0
}

_main() {
  MODE=$1
  [[ "$MODE" == "" ]] && _fail_no_mode
  [[ "$2" == "from_auto" ]] && echo "Auto detected mode \"$MODE\""

  set +e
  OTHER=`xrandr | grep ' connected' | awk '{print $1}' | grep -v $MAIN | head -n1`
  [[ "$OTHER" != "" ]] && xrandr --output $OTHER --auto
  set -e

  killall randy 2>/dev/null || true

  case $MODE in
  "above" | "work")
    _do_work || {
      _check $OTHER
      xrandr --output $OTHER --above $MAIN
    }
    pgrep xosview || {
      xosview &
      sleep 0.100
    }
    wmctrl -r xosview@iphands-fedora-PC2K41CN -e 0,4713,930,400,630
    ;;
  "same" | "same-as")
    _check $OTHER
    xrandr --output $OTHER --same-as $MAIN
    ;;
  "home")
    _check $OTHER
    xrandr --output $OTHER --right-of $MAIN
    xrandr --output $OTHER --pos 1920x-1080
    ;;
  "single")
    xrandr --auto
    xrandr --output $MAIN --auto
    ;;

  *) _fail_bad_mode $MODE
  esac

  # /home/iphands/prog/randy/target/release/randy ~/prog/randy/config/my_laptop_docked.yml &
  randy
  sleep 0.150
  fluxbox-remote restart
  sleep 0.150
  fbsetbg -c ~/Documents/tux.png
}

[[ "$1" == "" ]] && _do_auto $1
_main $1
