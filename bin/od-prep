#!/bin/bash
set -e

file="/tmp/od.host.id"
if [[ ! -f $file ]]
then
  echo "Could not find od host id file: $file"
  exit 1
fi

host="`cat $file`.od.fbinfra.net"
echo "Connecting to: $host"

mkdir -p ~/.od-prep/share-real
rm -rf ~/.od-prep/share || true
rsync -avPS ~/.od-prep/share-real/ ~/.od-prep/share/

pushd ~/.od-prep/share/prog/dotfiles
git pull --depth 1 || git pull --depth 1 --rebase
git gc --prune=all
rm -rf ../dotfiles/.git
rm -rf ../dotfiles/.emacs.d/eln-cache
popd

pushd ~/.od-prep/share
tar cvf prog.tar prog
zstd -fk9 prog.tar
popd

if [[ $1 == "--dry" ]]
then
  exit 0
fi

rsync -avPS ~/.od-prep/share/prog.tar.zst "${USER}@${host}:/tmp/"
ssh "${USER}@${host}" /bin/bash -c "echo '-- REMOTE' &&
echo '-- REMOTE' &&
pwd &&
zstd -df /tmp/prog.tar.zst &&
tar xvf /tmp/prog.tar &&
cd ~/prog/dotfiles &&
pwd && ls -lh &&
echo '-- installing dotfiles' &&
bash ./init.sh &&
echo '-- installing dirchomp' &&
mkdir -p ~/bin &&
zstd -df ~/prog/dirchomp.zst -o ~/bin/dirchomp &&
mkdir -p ~/j && cd ~/j &&
ln -fs ~/fbsource/fbcode/dataswarm-pipelines                        ./pipeline &&
ln -fs ~/fbsource/fbcode/dataswarm-pipelines/tasks/adsatlas/esad    ./pipeline-esad &&
ln -fs ~/www/flib/intern/scripts                                    ./intern-scripts &&
ln -fs ~/www/flib/intern/scripts/lift/config-drift                  ./config-drift &&
ln -fs ~/www/flib/intern/scripts/lift/esad                          ./esad-scripts &&
ln -fs ~/www/flib/intern/ads/study/incrementality_infra             ./esad-infra &&
ln -fs ~/www/html/intern/js/collab/smartoffice/gizmo/apps/dashboard ./gizmo-dash &&
ln -fs ~/www/html/intern/js/fbdoc/nodes                             ./markdown"
echo
